<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Astronomical Twilight Table</title>

<meta http-equiv="Content-Security-Policy" content="default-src 'self' https://unpkg.com https://nominatim.openstreetmap.org https://timeapi.io; script-src 'self' 'unsafe-inline' https://unpkg.com; connect-src https://nominatim.openstreetmap.org https://timeapi.io; style-src 'self' 'unsafe-inline'; img-src 'self' data:;">

<script src="https://unpkg.com/suncalc@1.9.0/suncalc.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  margin: 40px auto;
  max-width: 700px;
  background: #fafafa;
}

h1 { text-align: center; }

input {
  width: 100%;
  padding: 10px;
  font-size: 16px;
  margin-bottom: 20px;
}

.table-frame {
  height: 420px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 12px;
  background: white;
}

table { width: 100%; border-collapse: collapse; }

td { padding: 10px 14px; border-bottom: 1px solid #eee; }

.highlight { background: #eef6ff; font-weight: bold; }
</style>
</head>
<body>
<h1>Astronomical Twilight Start</h1>
<input id="city" placeholder="Detecting your locationâ€¦" autocomplete="off" />

<div class="table-frame">
  <table id="twilight-table"></table>
</div>

<script>
if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
  location.href = 'https:' + window.location.href.substring(window.location.protocol.length);
}

let lat = 51.92;
let lon = 4.48;
let timeZone = 'Europe/Amsterdam';

const table = document.getElementById('twilight-table');
const cityInput = document.getElementById('city');

function sanitizeInput(str) {
  return str.replace(/[<>\"']/g, '').trim();
}

function formatDate(d){
  return d.toLocaleDateString(undefined,{weekday:'short',year:'numeric',month:'short',day:'numeric', timeZone});
}

function formatTime(d){
  return d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', timeZone});
}

function buildTable(){
  table.innerHTML='';
  const today = new Date();
  today.setHours(0,0,0,0);

  for(let i=-7;i<=7;i++){
    const d=new Date(today);
    d.setDate(today.getDate()+i);

    const times=SunCalc.getTimes(d,lat,lon);
    const twilight=times.nightEnd;

    const tr=document.createElement('tr');
    if(i===0) tr.classList.add('highlight');

    const tdDate=document.createElement('td');
    tdDate.textContent=formatDate(d);

    const tdTime=document.createElement('td');
    tdTime.textContent=formatTime(twilight);

    tr.appendChild(tdDate);
    tr.appendChild(tdTime);
    table.appendChild(tr);
  }

  setTimeout(()=>{
    const highlight=document.querySelector('.highlight');
    if(highlight){
      highlight.scrollIntoView({block:'center'});
    }
  },50);
}

async function lookupTimezone(){
  try{
    const tzRes = await fetch(`https://timeapi.io/api/TimeZone/coordinate?latitude=${lat}&longitude=${lon}`, {referrerPolicy:'no-referrer'});
    const tzData = await tzRes.json();
    if(tzData.timeZone) timeZone = tzData.timeZone;
  }catch(e){ console.warn('Timezone lookup failed'); }
}

async function searchCity(city){
  city = sanitizeInput(city);
  if(!city) return;

  const url=`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`;
  const res=await fetch(url,{referrerPolicy:'no-referrer'});
  const data=await res.json();

  if(data.length){
    lat=parseFloat(data[0].lat);
    lon=parseFloat(data[0].lon);
    cityInput.value=data[0].display_name;
    await lookupTimezone();
    buildTable();
  }else{
    alert('City not found');
  }
}

async function detectLocation(){
  if(!navigator.geolocation){
    cityInput.placeholder='Enter city and press Enter';
    buildTable();
    return;
  }

  navigator.geolocation.getCurrentPosition(async pos=>{
    lat=pos.coords.latitude;
    lon=pos.coords.longitude;

    try{
      const geoRes = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`,{referrerPolicy:'no-referrer'});
      const geoData = await geoRes.json();
      cityInput.value = geoData.display_name || '';
    }catch{}

    await lookupTimezone();
    buildTable();
    cityInput.placeholder='Enter city and press Enter';
  },()=>{
    cityInput.placeholder='Enter city and press Enter';
    buildTable();
  });
}

cityInput.addEventListener('keydown',e=>{
  if(e.key==='Enter') searchCity(e.target.value);
});

// initial auto-detect

detectLocation();
</script>
</body>
</html>
